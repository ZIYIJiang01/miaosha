<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link href="bootstrap.min.css" rel="stylesheet" type="text/css"/>
    <link href="components.css" rel="stylesheet" type="text/css"/>
    <link href="login.css" rel="stylesheet" type="text/css"/>

    <!-- Correctly referencing the jQuery library -->
    <script src="https://code.jquery.com/jquery-1.11.0.min.js"></script>
    <script type="text/javascript">
        function getParam(paramName) {
            var paramValue = "";
            var isFound = false;

            if (this.location.search.indexOf("?") === 0 && this.location.search.indexOf("=") > 1) {
                var arrSource = unescape(this.location.search).substring(1, this.location.search.length).split("&");
                var i = 0;
                while (i < arrSource.length && !isFound) {
                    if (arrSource[i].indexOf("=") > 0) {
                        if (arrSource[i].split("=")[0].toLowerCase() === paramName.toLowerCase()) {
                            paramValue = arrSource[i].split("=")[1];
                            isFound = true;
                        }
                    }
                    i++;
                }
            }
            return paramValue;
        }

        var g_itemVO = {};
        console.log(g_itemVO)
        function updateCountdown() {
            if (g_itemVO.promoStatus === 1) {
                var startTime = new Date(g_itemVO.startDate.replace(/-/g, "/")).getTime();
                var nowTime = Date.now();
                var delta = (startTime - nowTime) / 1000;
                if (delta <= 0) {
                    g_itemVO.promoStatus = 2;
                    reloadDom();
                } else {
                    $("#promoStartDate").text("Promotion will start on " + g_itemVO.startDate + " countdown: " + Math.floor(delta) + " seconds");
                }
            }
        }

        function reloadDom() {
            $("#title").text(g_itemVO.title);
            $("#description").text(g_itemVO.description);
            $("#stock").text(g_itemVO.stock);
            $("#price").text(g_itemVO.price);
            $("#imgUtl").attr("src", g_itemVO.imgUrl);
            $("#sales").text(g_itemVO.sales);

            if (g_itemVO.promoStatus === 1) {
                // Promotion doesn't begin
                updateCountdown();
                $("#promoPrice").text(g_itemVO.promoPrice);
                $("#createorder").attr("disabled", true);
            } else if (g_itemVO.promoStatus === 2) {
                // Promotion ongoing
                $("#promoStartDate").text("Promotion ongoing");
                $("#promoPrice").text(g_itemVO.promoPrice);
                $("#createorder").attr("disabled", false);
                $("#normalPriceContainer").hide();
            }
        }

        jQuery(document).ready(function($) {
            $("#createorder").on("click", function() {
                $.ajax({
                    type: "POST",
                    contentType: "application/x-www-form-urlencoded",
                    url: "http://localhost:8080/order/createorder",
                    data: {
                        "itemId": g_itemVO.id,
                        "amount": 1,
                        "promoId":g_itemVO.promoId
                    },
                    xhrFields: {withCredentials: true},
                    success: function(data) {
                        if (data.status === "success") {
                            alert("Order success");
                            window.location.reload();
                        } else {
                            alert("Order failed, because: " + data.data.errMsg);
                            if(data.data.errCode === 20003){
                                window.location.href = "login.html";
                            }
                        }
                    },
                    error: function(data) {
                        alert("Order failed, because: " + data.responseText);
                    }
                });
            });

            $.ajax({
                type: "GET",
                url: "http://localhost:8080/item/get",
                data: {
                    "id": getParam("id")
                },
                xhrFields: { withCredentials: true },
                success: function(data) {
                    if (data.status === "success") {
                        g_itemVO = data.data;
                        console.log(g_itemVO.startDate); // Check the date format
                        console.log(g_itemVO.promoItemPrice); // Check the promo price
                        reloadDom();
                        setInterval(updateCountdown, 1000); // Update countdown every second
                    } else {
                        alert("Get information failed, because: " + data.data.errMsg);
                    }
                },
                error: function(data) {
                    alert("Get information failed, because: " + data.responseText);
                }
            });
        });
    </script>
</head>
<body class="login">
<div class="content">
    <h3 class="form-title">Item Detail</h3>
    <div id="promoStartDateContainer" class="form-group">
        <label style="color: blue" id="promoStatus" class="control-label"></label>
        <div>
            <label style="color: red" class="control-label" id="promoStartDate"></label>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">Item Title</label>
        <div>
            <label class="control-label" id="title"></label>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">Item Description</label>
        <div>
            <label class="control-label" id="description"></label>
        </div>
    </div>
    <div id="normalPriceContainer" class="form-group">
        <label class="control-label">Item Price</label>
        <div>
            <label class="control-label" id="price"></label>
        </div>
    </div>
    <div id="promoPriceContainer" class="form-group">
        <label style="color: red" class="control-label">Item Promotion Price</label>
        <div>
            <label style="color: red" class="control-label" id="promoPrice"></label>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">Picture</label>
        <div>
            <img style="width:200px; height:auto" id="imgUtl"/>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">Stock</label>
        <div>
            <label class="control-label" id="stock"></label>
        </div>
    </div>
    <div class="form-group">
        <label class="control-label">Sales</label>
        <div>
            <label class="control-label" id="sales"></label>
        </div>
    </div>
    <div class="form-action">
        <button class="btn blue" id="createorder" type="submit">
            Order
        </button>
    </div>
</div>
</body>
</html>
